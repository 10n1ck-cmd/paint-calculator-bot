<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Paint Calc</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{font-family:system-ui;background:#f4f6f8;margin:0}
.container{max-width:420px;margin:auto;padding:16px}
button,input{width:100%;padding:10px;margin-top:6px;font-size:15px}
button{background:#2a9df4;color:#fff;border:0;border-radius:8px}
.card{background:#fff;padding:12px;border-radius:10px;margin-top:10px}
.result{background:#e9f5ff;padding:10px;border-radius:8px;margin-top:10px}
.hidden{display:none}
</style>
</head>

<body>
<div class="container">

<h3>üé® –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h3>

<button onclick="show('theory')">üéì –¢–µ–æ—Ä–∏—è</button>
<button onclick="show('practice')">üîß –ü—Ä–∞–∫—Ç–∏–∫–∞</button>

<!-- –¢–ï–û–†–ò–Ø -->
<div id="theory" class="card hidden">
<h4>üéì –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç</h4>
<input id="t_area" placeholder="–ü–ª–æ—â–∞–¥—å –º¬≤">

<h5>–ö—Ä–∞—Å–∫–∞ 1</h5>
<input id="t1_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
<input id="t1_d" placeholder="–ü–ª–æ—Ç–Ω–æ—Å—Ç—å">
<input id="t1_t" placeholder="–¢–æ–ª—â–∏–Ω–∞">
<input id="t1_p" placeholder="–¶–µ–Ω–∞">

<h5>–ö—Ä–∞—Å–∫–∞ 2</h5>
<input id="t2_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
<input id="t2_d" placeholder="–ü–ª–æ—Ç–Ω–æ—Å—Ç—å">
<input id="t2_t" placeholder="–¢–æ–ª—â–∏–Ω–∞">
<input id="t2_p" placeholder="–¶–µ–Ω–∞">

<button onclick="calcTheory()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
</div>

<!-- –ü–†–ê–ö–¢–ò–ö–ê -->
<div id="practice" class="card hidden">
<h4>üîß –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç</h4>
<input id="p_area" placeholder="–ü–ª–æ—â–∞–¥—å –º¬≤">

<h5>–ö—Ä–∞—Å–∫–∞ 1</h5>
<input id="p1_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
<input id="p1_c" placeholder="–†–∞—Å—Ö–æ–¥ –∫–≥">
<input id="p1_p" placeholder="–¶–µ–Ω–∞">

<h5>–ö—Ä–∞—Å–∫–∞ 2</h5>
<input id="p2_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
<input id="p2_c" placeholder="–†–∞—Å—Ö–æ–¥ –∫–≥">
<input id="p2_p" placeholder="–¶–µ–Ω–∞">

<button onclick="calcPractice()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
</div>

<div id="out" class="result hidden"></div>

<button id="orderBtn" class="hidden" onclick="showOrder()">
üî• –ü–æ–ª—É—á–∏—Ç—å –±–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
</button>

<!-- –ó–ê–ö–ê–ó -->
<div id="orderForm" class="card hidden">
<h4>üõí –ó–∞–∫–∞–∑</h4>
<input id="surface" placeholder="–¢–∏–ø –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏">
<input id="color" placeholder="–¶–≤–µ—Ç">
<input id="qty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∫–≥)">
<button onclick="order()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
</div>

</div>

<script>
Telegram.WebApp.expand();
let last;

function v(id){return parseFloat(document.getElementById(id).value.replace(',','.'));}

function show(id){
    theory.classList.add('hidden');
    practice.classList.add('hidden');
    out.classList.add('hidden');
    orderBtn.classList.add('hidden');
    orderForm.classList.add('hidden');
    document.getElementById(id).classList.remove('hidden');
}

async function send(data){
    const r = await fetch('/api/calc',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(data)
    });
    return await r.json();
}

async function calcTheory(){
    last = await send({
        mode:'theory',
        area:v('t_area'),
        paints:[
            {name:t1_name.value,density:v('t1_d'),thickness:v('t1_t'),price:v('t1_p')},
            {name:t2_name.value,density:v('t2_d'),thickness:v('t2_t'),price:v('t2_p')}
        ]
    });
    showResult();
}

async function calcPractice(){
    last = await send({
        mode:'practice',
        area:v('p_area'),
        paints:[
            {name:p1_name.value,consumption:v('p1_c'),price:v('p1_p')},
            {name:p2_name.value,consumption:v('p2_c'),price:v('p2_p')}
        ]
    });
    showResult();
}

function showResult(){
    out.innerHTML =
        last.results.map(r=>`
            <b>${r.name}</b><br>
            –°—Ç–æ–∏–º–æ—Å—Ç—å: ${r.cost} ‚ÇΩ<br>
            –¶–µ–Ω–∞ –º¬≤: ${r.cost_per_sqm} ‚ÇΩ<br><br>
        `).join('')
        + `<b>–í—ã–≥–æ–¥–Ω–µ–µ: ${last.cheaper.name}</b><br>`
        + `<b>–≠–∫–æ–Ω–æ–º–∏—è: ${last.diff_percent}%</b>`;

    out.classList.remove('hidden');
    orderBtn.classList.remove('hidden');
}

function showOrder(){
    orderForm.classList.remove('hidden');
}

async function order(){
    await fetch('/api/order',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            mode:last.mode,
            area:last.area,
            paint:last.cheaper.name,
            economy:last.diff_percent,
            surface:surface.value,
            color:color.value,
            qty:qty.value,
            cost:last.cheaper.cost
        })
    });
    alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
}
</script>
</body>
</html>
