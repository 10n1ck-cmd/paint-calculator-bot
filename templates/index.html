<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>Paint Calc</title>

<style>
html,body{margin:0;height:100%;font-family:system-ui}
.wrapper{height:100%;overflow-y:auto;padding:12px;background:#f4f6f8}
.card{background:#fff;padding:12px;border-radius:12px;margin-bottom:10px}
input,select,button{width:100%;padding:10px;margin-top:6px}
button{background:#2a9df4;color:#fff;border:0;border-radius:8px}
.fixed{
    position:sticky;
    bottom:0;
    background:#f4f6f8;
    padding:10px 0;
}
.hidden{display:none}
</style>
</head>

<body>
<div class="wrapper">

<button onclick="show('theory')">üéì –¢–µ–æ—Ä–∏—è</button>
<button onclick="show('practice')">üîß –ü—Ä–∞–∫—Ç–∏–∫–∞</button>

<div id="theory" class="card hidden">
<input id="ta" placeholder="–ü–ª–æ—â–∞–¥—å –º¬≤">
<input id="t1n" placeholder="–ö—Ä–∞—Å–∫–∞ 1">
<input id="t1d" placeholder="–ü–ª–æ—Ç–Ω–æ—Å—Ç—å">
<input id="t1t" placeholder="–¢–æ–ª—â–∏–Ω–∞">
<input id="t1p" placeholder="–¶–µ–Ω–∞ —Ä—É–±/–∫–≥">
<input id="t2n" placeholder="–ö—Ä–∞—Å–∫–∞ 2">
<input id="t2d" placeholder="–ü–ª–æ—Ç–Ω–æ—Å—Ç—å">
<input id="t2t" placeholder="–¢–æ–ª—â–∏–Ω–∞">
<input id="t2p" placeholder="–¶–µ–Ω–∞ —Ä—É–±/–∫–≥">
<button onclick="calc('theory')">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
</div>

<div id="practice" class="card hidden">
<input id="pa" placeholder="–ü–ª–æ—â–∞–¥—å –º¬≤">
<input id="p1n" placeholder="–ö—Ä–∞—Å–∫–∞ 1">
<input id="p1c" placeholder="–†–∞—Å—Ö–æ–¥ –∫–≥">
<input id="p1p" placeholder="–¶–µ–Ω–∞ —Ä—É–±/–∫–≥">
<input id="p2n" placeholder="–ö—Ä–∞—Å–∫–∞ 2">
<input id="p2c" placeholder="–†–∞—Å—Ö–æ–¥ –∫–≥">
<input id="p2p" placeholder="–¶–µ–Ω–∞ —Ä—É–±/–∫–≥">
<button onclick="calc('practice')">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
</div>

<div id="out" class="card hidden"></div>

<div class="fixed">
<button id="orderBtn" class="hidden" onclick="show('order')">
üî• –ü–æ–ª—É—á–∏—Ç—å –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
</button>
</div>

<div id="order" class="card hidden">
<select id="surface">
<option>–ú–∞—Ç</option><option>–ì–ª—è–Ω–µ—Ü</option>
</select>
<select id="color">
<option>RAL 9005</option><option>RAL 9016</option>
</select>
<input id="qty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≥">
<button onclick="order()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

</div>

<script>
const tg = Telegram.WebApp;
const tgUser = tg.initDataUnsafe.user || null;
let last;

function v(id){return parseFloat(document.getElementById(id).value.replace(',','.'));}

function show(id){
 document.querySelectorAll('.card').forEach(e=>e.classList.add('hidden'));
 document.getElementById(id).classList.remove('hidden');
}

async function calc(mode){
 const d = mode==='theory'?{
  mode,area:v('ta'),
  paints:[
   {name:t1n.value,density:v('t1d'),thickness:v('t1t'),price:v('t1p')},
   {name:t2n.value,density:v('t2d'),thickness:v('t2t'),price:v('t2p')}
  ]
 }:{
  mode,area:v('pa'),
  paints:[
   {name:p1n.value,consumption:v('p1c'),price:v('p1p')},
   {name:p2n.value,consumption:v('p2c'),price:v('p2p')}
  ]
 };

 last = await fetch('/api/calc',{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify(d)
 }).then(r=>r.json());

 out.innerHTML =
  last.results.map(p=>`<b>${p.name}</b><br>${p.cost} —Ä—É–±.<br>`).join('<br>')+
  `<br><b>–í—ã–≥–æ–¥–Ω–µ–µ:</b> ${last.cheaper.name}<br>–≠–∫–æ–Ω–æ–º–∏—è: ${last.economy}%`;

 out.classList.remove('hidden');
 orderBtn.classList.remove('hidden');
}

function order(){
 fetch('/api/order',{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({
   ...last,
   surface:surface.value,
   color:color.value,
   qty:qty.value,
   tg_user:tgUser
  })
 });
 alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É');
}
</script>
</body>
</html>
