<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>Paint Calculator</title>

<style>
html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui}
.wrapper{height:100%;overflow-y:auto;padding:12px;background:#f4f6f8}
.card{background:#fff;padding:12px;border-radius:10px;margin-bottom:10px}
button,input,select{width:100%;padding:10px;margin-top:6px}
button{background:#2a9df4;color:#fff;border:0;border-radius:8px}
.hidden{display:none}
</style>
</head>

<body>
<div class="wrapper">

<button onclick="show('theory')">üéì –¢–µ–æ—Ä–∏—è</button>
<button onclick="show('practice')">üîß –ü—Ä–∞–∫—Ç–∏–∫–∞</button>

<div id="theory" class="card hidden">
<input id="ta" placeholder="–ü–ª–æ—â–∞–¥—å, –º¬≤">
<input id="t1n" placeholder="–ö—Ä–∞—Å–∫–∞ 1">
<input id="t1d" placeholder="–ü–ª–æ—Ç–Ω–æ—Å—Ç—å">
<input id="t1t" placeholder="–¢–æ–ª—â–∏–Ω–∞">
<input id="t1p" placeholder="–¶–µ–Ω–∞, —Ä—É–±/–∫–≥">
<input id="t2n" placeholder="–ö—Ä–∞—Å–∫–∞ 2">
<input id="t2d" placeholder="–ü–ª–æ—Ç–Ω–æ—Å—Ç—å">
<input id="t2t" placeholder="–¢–æ–ª—â–∏–Ω–∞">
<input id="t2p" placeholder="–¶–µ–Ω–∞, —Ä—É–±/–∫–≥">
<button onclick="calc('theory')">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
</div>

<div id="practice" class="card hidden">
<input id="pa" placeholder="–ü–ª–æ—â–∞–¥—å, –º¬≤">
<input id="p1n" placeholder="–ö—Ä–∞—Å–∫–∞ 1">
<input id="p1c" placeholder="–†–∞—Å—Ö–æ–¥, –∫–≥">
<input id="p1p" placeholder="–¶–µ–Ω–∞, —Ä—É–±/–∫–≥">
<input id="p2n" placeholder="–ö—Ä–∞—Å–∫–∞ 2">
<input id="p2c" placeholder="–†–∞—Å—Ö–æ–¥, –∫–≥">
<input id="p2p" placeholder="–¶–µ–Ω–∞, —Ä—É–±/–∫–≥">
<button onclick="calc('practice')">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
</div>

<div id="out" class="card hidden"></div>

<button id="pdfBtn" class="hidden" onclick="downloadPdf()">üìÑ –°–∫–∞—á–∞—Ç—å PDF</button>
<button id="orderBtn" class="hidden" onclick="show('order')">
üî• –ü–æ–ª—É—á–∏—Ç—å –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
</button>

<div id="order" class="card hidden">
<select id="surface">
<option>–ì–ª—è–Ω–µ—Ü</option>
<option>–ú–∞—Ç</option>
<option>–®–∞–≥—Ä–µ–Ω—å</option>
<option>–ú—É–∞—Ä</option>
</select>

<select id="color">
<option>RAL 9005</option>
<option>RAL 9016</option>
<option>RAL 7024</option>
<option>–î—Ä—É–≥–æ–π</option>
</select>

<input id="qty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∫–≥">
<button onclick="order()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
</div>

</div>

<script>
Telegram.WebApp.expand();
let last;

function v(id){
    return parseFloat(document.getElementById(id).value.replace(',','.'));
}

function show(id){
    document.querySelectorAll('.card').forEach(e=>e.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}

async function calc(mode){
    const data = mode==='theory' ? {
        mode, area:v('ta'),
        paints:[
            {name:t1n.value,density:v('t1d'),thickness:v('t1t'),price:v('t1p')},
            {name:t2n.value,density:v('t2d'),thickness:v('t2t'),price:v('t2p')}
        ]
    } : {
        mode, area:v('pa'),
        paints:[
            {name:p1n.value,consumption:v('p1c'),price:v('p1p')},
            {name:p2n.value,consumption:v('p2c'),price:v('p2p')}
        ]
    };

    last = await fetch('/api/calc',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(data)
    }).then(r=>r.json());

    out.innerHTML = last.results.map(p =>
        `<b>${p.name}</b><br>
         –°—Ç–æ–∏–º–æ—Å—Ç—å: ${p.cost} —Ä—É–±.<br>
         –¶–µ–Ω–∞ –º¬≤: ${p.cost_per_sqm} —Ä—É–±./–º¬≤<br><br>`
    ).join('') +
    `<b>–≠–∫–æ–Ω–æ–º–∏—è: ${last.economy} %</b>`;

    out.classList.remove('hidden');
    pdfBtn.classList.remove('hidden');
    orderBtn.classList.remove('hidden');
}

function downloadPdf(){
    fetch('/api/pdf',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(last)
    }).then(r=>r.blob()).then(b=>{
        const a=document.createElement('a');
        a.href=URL.createObjectURL(b);
        a.download='comparison.pdf';
        a.click();
    });
}

function order(){
    fetch('/api/order',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            ...last,
            surface:surface.value,
            color:color.value,
            qty:qty.value
        })
    });
    alert('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä—É');
}
</script>
</body>
</html>
