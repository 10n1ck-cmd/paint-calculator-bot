<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Paint Calc</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{font-family:system-ui;background:#f4f6f8;margin:0}
.container{max-width:420px;margin:auto;padding:16px}
input,button{width:100%;padding:10px;margin-top:6px;font-size:15px}
button{background:#2a9df4;color:#fff;border:0;border-radius:8px}
.card{background:#fff;padding:12px;border-radius:10px;margin-top:10px}
.result{background:#e9f5ff;padding:10px;border-radius:8px}
</style>
</head>

<body>
<div class="container">

<h3>üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –∫—Ä–∞—Å–æ–∫</h3>

<div class="card">
<input id="area" placeholder="–ü–ª–æ—â–∞–¥—å –º¬≤">

<h4>–ö—Ä–∞—Å–∫–∞ 1</h4>
<input id="p1_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
<input id="p1_cons" placeholder="–†–∞—Å—Ö–æ–¥ –∫–≥">
<input id="p1_price" placeholder="–¶–µ–Ω–∞ ‚ÇΩ">

<h4>–ö—Ä–∞—Å–∫–∞ 2</h4>
<input id="p2_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
<input id="p2_cons" placeholder="–†–∞—Å—Ö–æ–¥ –∫–≥">
<input id="p2_price" placeholder="–¶–µ–Ω–∞ ‚ÇΩ">

<button onclick="calc()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
</div>

<div id="out" class="result"></div>

<button onclick="makePDF()">üìÑ PDF</button>

<div class="card">
<h4>üõí –ó–∞–∫–∞–∑</h4>
<input id="name" placeholder="–ò–º—è">
<input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
<input id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
<button onclick="order()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
</div>

</div>

<script>
Telegram.WebApp.expand();
let last;

function v(id){return parseFloat(document.getElementById(id).value.replace(',', '.'));}

async function calc(){
    const data = {
        mode:'practical',
        area:v('area'),
        paints:[
            {name:p1_name.value, consumption:v('p1_cons'), price:v('p1_price')},
            {name:p2_name.value, consumption:v('p2_cons'), price:v('p2_price')}
        ]
    };
    const r = await fetch('/api/calculate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).then(r=>r.json());
    last = r;

    out.innerHTML = r.results.map(p=>`
        <b>${p.name}</b><br>
        –°—Ç–æ–∏–º–æ—Å—Ç—å: ${p.cost} ‚ÇΩ<br>
        –¶–µ–Ω–∞ –º¬≤: ${p.cost_per_sqm} ‚ÇΩ<br><br>
    `).join('') + `<b>–í—ã–≥–æ–¥–Ω–µ–µ: ${r.cheaper.name}</b>`;
}

async function makePDF(){
    const r = await fetch('/api/pdf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({area:area.value,results:last.results})});
    const blob = await r.blob();
    Telegram.WebApp.openLink(URL.createObjectURL(blob));
}

async function order(){
    await fetch('/api/order',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            name:name.value,
            phone:phone.value,
            comment:comment.value,
            paint:last.cheaper.name,
            cost:last.cheaper.cost
        })
    });
    alert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
}
</script>
</body>
</html>
